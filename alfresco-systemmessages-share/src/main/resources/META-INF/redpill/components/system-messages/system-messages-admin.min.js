'use strict';var Redpill=Redpill||{};Alfresco.logger.debug("system-messages-admin.js");Redpill.SystemMessages=function(a){Redpill.SystemMessages.superclass.constructor.call(this,"Redpill.SystemMessages",a,"button container datasource datatable paginator history animation".split(" "));return this};
YAHOO.extend(Redpill.SystemMessages,Alfresco.component.Base,{notificationsUrl:Alfresco.constants.PROXY_URI+"api/redpill/notifications",onReady:function(){Alfresco.logger.debug("onReady",arguments);Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/redpill/notifications/datalist",responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(a){console.log(a);this.dataList=a.json.nodeRef},scope:this},failureMessage:this.msg("operation.failed")});this.setupDataTable();this.setupNewMessageButton();
Alfresco.logger.debug("END onReady")},setupNewMessageButton:function(){this.widgets.newMessageButton=new YAHOO.widget.Button(this.id+"-new-message");this.widgets.newMessageButton.on("click",function(){this.onNewRow()},null,this)},actionFormatter:function(a,d,c,b){Alfresco.logger.debug("actionFormatter",arguments);d.getData();a.innerHTML="<div class='action'><a class='edit-message'>"+this.msg("button.edit")+"</a> | <a class='delete-message'>"+this.msg("button.delete")+"</a></div>";Alfresco.logger.debug("END actionFormatter")},
timeFormatter:function(a,d,c,b){null!==b?(d=Alfresco.util.fromISO8601(b),a.innerHTML=Alfresco.util.formatDate(d)):a.innerHTML=this.msg("label.none")},typeFormatter:function(a,d,c,b){d="";b&&(d=this.msg("systemmessages.priority."+b.toLowerCase()));a.innerHTML=d},setupDataTable:function(){Alfresco.logger.debug("setupDataTable",arguments);var a=[{key:"title",label:this.msg("title.title"),sortable:!1},{key:"text",label:this.msg("title.text"),sortable:!1},{key:"startTime",label:this.msg("title.startTime"),
sortable:!0,formatter:this.timeFormatter.bind(this)},{key:"endTime",label:this.msg("title.endTime"),sortable:!0,formatter:this.timeFormatter.bind(this)},{key:"type",label:this.msg("title.type"),sortable:!1,formatter:this.typeFormatter.bind(this)},{key:"actions",label:this.msg("title.actions"),sortable:!1,formatter:this.actionFormatter.bind(this)}],d=this.widgets.dataSource=new YAHOO.util.DataSource(this.notificationsUrl,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"notifications",
fields:"id nodeRef title text startTime endTime type".split(" ")}});a=this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-messages",a,d,{initialLoad:{},MSG_LOADING:this.msg("loading.messages"),MSG_EMPTY:this.msg("no.messages.found")});a.subscribe("rowMouseoverEvent",a.onEventHighlightRow);a.subscribe("rowMouseoutEvent",a.onEventUnhighlightRow);YAHOO.util.Event.delegate(this.id,"click",this.onEditRow.bind(this),"a.edit-message");YAHOO.util.Event.delegate(this.id,"click",this.onDeleteRow.bind(this),
"a.delete-message")},onDeleteRow:function(a,d){var c=this.widgets.dataTable.getRecord(d.parentNode.parentNode.parentNode);a=Alfresco.util.NodeRef(c.getData().nodeRef);a=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/redpill/delete/{storeType}/{storeId}/{id}",a);confirm(this.msg("message.delete.confirm"))&&Alfresco.util.Ajax.jsonDelete({url:a,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(b){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete.success",
c.getData().title)});this.widgets.dataTable.deleteRow(c)},scope:this},failureMessage:this.msg("operation.failed")})},onNewRow:function(a,d){a=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"rlsm:systemMessage",destination:this.dataList,mode:"create",submitType:"json"});(new Alfresco.module.SimpleDialog(this.id+"-createRow")).setOptions({templateUrl:a,
actionUrl:null,destroyOnHide:!0,doBeforeDialogShow:{fn:function(c,b){Alfresco.util.populateHTML([b.id+"-dialogTitle",this.msg("label.new-row.title")],[b.id+"-dialogHeader",this.msg("label.new-row.header")])},scope:this},onSuccess:{fn:function(c){var b=c.config.dataObj;c=Alfresco.util.NodeRef(c.json.persistedObject);b={id:c.id,nodeRef:c.toString(),title:b.prop_rlsm_systemMessageTitle,text:b.prop_rlsm_systemMessageDescription,type:b.prop_rlsm_systemMessagePriority,startTime:b.prop_rlsm_systemMessageStartTime,
endTime:b.prop_rlsm_systemMessageEndTime};Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-row.success")});this.widgets.dataTable.addRow(b)},scope:this},onFailure:{fn:function(c){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-row.failure")})},scope:this}}).show()},onEditRow:function(a,d){var c=this.widgets.dataTable.getRecord(d.parentNode.parentNode.parentNode),b=c.getData();a=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?submitType=json&itemKind={itemKind}&itemId={itemId}&mode={mode}&showCancelButton=true",
{itemKind:"node",itemId:b.nodeRef,mode:"edit"});(new Alfresco.module.SimpleDialog(this.id+"-editRow")).setOptions({templateUrl:a,actionUrl:null,destroyOnHide:!0,doBeforeDialogShow:{fn:function(e,f){Alfresco.util.populateHTML([f.id+"-dialogTitle",this.msg("label.new-row.title")],[f.id+"-dialogHeader",this.msg("label.new-row.header")])},scope:this},onSuccess:{fn:function(e){e=e.config.dataObj;b.text=e.prop_rlsm_systemMessageDescription;b.title=e.prop_rlsm_systemMessageTitle;b.type=e.prop_rlsm_systemMessagePriority;
b.startTime=e.prop_rlsm_systemMessageStartTime;b.endTime=e.prop_rlsm_systemMessageEndTime;Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit.success")});this.widgets.dataTable.updateRow(c,b)},scope:this},onFailure:{fn:function(e){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit.failure")})},scope:this}}).show()}});
